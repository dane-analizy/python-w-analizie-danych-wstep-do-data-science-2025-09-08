# 6. Pandas - grupowanie, pivoty i łączenie danych

## GroupBy i agregacje  

GroupBy pozwala podzielić dane na grupy według wybranego kryterium, a następnie wykonać na nich podsumowania, transformacje lub selekcje. To podstawowe narzędzie do analizy grupowej danych.

Przykładowy DataFrame:  

```python
import pandas as pd

data = {
    'Kategoria': ['A', 'A', 'B', 'B', 'C', 'C'],
    'Wartosc': [10, 15, 10, 20, 10, 30],
    'Ilość': [1, 2, 1, 3, 1, 1]
}
df = pd.DataFrame(data)
```

### `groupby()`  

Dzieli DataFrame na grupy według wartości w kolumnie.  

```python
grupy = df.groupby('Kategoria')  

print(grupy)
```

Zadanie: Podziel df według 'Kategoria' i wyświetl średnią kolumny 'Wartosc' dla każdej grupy.

***

### `aggregate()`  

Pozwala wykonać różne funkcje agregujące na kolumnach grup.  

* zapis rozdzielony na wiele linii - nawiasy albo `\`

```python
agg = df.groupby('Kategoria').aggregate({'Wartosc': 'sum', 'Ilość': 'max'})

print(agg)
```

Zadanie: Policz sumę 'Wartosc' oraz maksymalną 'Ilość' dla każdej kategorii.

***

### `transform()`  

Zwraca wynik o takim samym kształcie jak oryginał, np. ułatwia normalizację danych wewnątrz grup.  

```python
df['Średnia_w_grupie'] = df.groupby('Kategoria')['Wartosc'].transform('mean')
print(df)
```

Zadanie: Dodaj do df kolumnę z medianą 'Wartosc' w każdej grupie.

***

### `first()` / `last()`  

Zwraca pierwszy lub ostatni wiersz z każdej grupy.  

```python
print(df.groupby('Kategoria').first())
print(df.groupby('Kategoria').last())
```

Sortowanie po kolumnie 'Wartosc' i wybór najnowszego (największego) oraz najstarszego (najmniejszego) rekordu w każdej grupie:

```python
# Najnowszy rekord (największa 'Wartosc') w każdej grupie
najnowszy = df.sort_values('Wartosc').groupby('Kategoria').last()
print(najnowszy)

# Najstarszy rekord (najmniejsza 'Wartosc') w każdej grupie
najstarszy = df.sort_values('Wartosc').groupby('Kategoria').first()
print(najstarszy)
```

Najczęściej najpierw sortujemy dane według kolumny, która nas interesuje (np. 'Wartosc'), a następnie grupujemy (`groupby`) i wybieramy pierwszy lub ostatni wiersz z każdej grupy. Dzięki temu mamy pewność, że wybieramy rekordy zgodnie z ustalonym porządkiem. Przykład:

```python
# Najpierw sortujemy, potem grupujemy i wybieramy
najwyzszy = df.sort_values('Wartosc').groupby('Kategoria').last()
```

Gdybyśmy najpierw zgrupowali, a potem sortowali, sortowanie działałoby już tylko w obrębie wyników agregacji, a nie oryginalnych danych.

Zadanie: Wyświetl pierwszy i ostatni wiersz każdej grupy 'Kategoria'.

***

## Tabele przestawne  

Pivot tables pozwalają przekształcać i podsumowywać dane łatwo i szybko.  

```python
pivot = df.pivot_table(values='Wartosc', index='Kategoria', aggfunc='sum')
print(pivot)
```

Zadanie: Utwórz tabelę przestawną pokazującą sumę 'Ilość' dla każdej 'Kategoria'.

***

## Łączenie danych  

W analizie często łączymy różne zbiory danych, np. wynikające z różnych źródeł.

### `concat`  

Łączy DataFrame’ y pionowo lub poziomo.  

```python
df1 = pd.DataFrame({'A': [1, 2], 'B': [3, 4]})
df2 = pd.DataFrame({'A': [5, 6], 'B': [7, 8]})

result = pd.concat([df1, df2])

print(result)
```

Parametr `axis`:

```python
# Łączenie DataFrame w pionie (axis=0, domyślnie)
concat_pion = pd.concat([df1, df2], axis=0)
print("Pionowo (axis=0):")
print(concat_pion)

# Łączenie DataFrame w poziomie (axis=1)
concat_poziom = pd.concat([df1, df2], axis=1)
print("\nPoziomo (axis=1):")
print(concat_poziom)
```

Zadanie: Połącz df1 i df2 i wyświetl wynik.

***

### `merge`  

Łączy dane na podstawie wspólnych kolumn (join).  

```python
left = pd.DataFrame({'klucz': ['a', 'b', 'c'], 'left_val': [1, 2, 3]})
right = pd.DataFrame({'klucz': ['b', 'c', 'd'], 'right_val': [4, 5, 6]})

merged = pd.merge(left, right, on='klucz', how='inner')

print(merged)
```

```python
# Przykład: łączenie zamówień z danymi klientów
zamowienia = pd.DataFrame({
    'id_zamowienia': [101, 102, 103, 104],
    'id_klienta': [1, 2, 1, 3],
    'kwota': [250, 150, 300, 400]
})

klienci = pd.DataFrame({
    'id_klienta': [1, 2, 3],
    'nazwa': ['Anna', 'Bartek', 'Celina']
})

zamowienia_z_klientami = pd.merge(zamowienia, klienci, on='id_klienta', how='left')

print(zamowienia_z_klientami)
```

Zadanie: Połącz lewy i prawy DataFrame dostępne w przykładzie i wyświetl wynik złączony po kolumnie 'klucz'.
